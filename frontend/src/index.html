<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fake News Detector Â· DistilBERT + Gemini</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14; --panel:#0f1520; --muted:#9aa4b2; --text:#e6edf3; --primary:#6ee7b7; --accent:#60a5fa; --danger:#f87171; --warn:#fbbf24; --ok:#34d399;
      --card:#111827; --border:#223042; --chip:#1f2937;
    }
    .light {
      --bg:#f8fafc; --panel:#ffffff; --muted:#475569; --text:#0f172a; --primary:#059669; --accent:#2563eb; --danger:#dc2626; --warn:#d97706; --ok:#16a34a;
      --card:#ffffff; --border:#e2e8f0; --chip:#f1f5f9;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    a { color: var(--accent); text-decoration: none; }
    header { position: sticky; top:0; z-index:10; backdrop-filter: blur(8px); background: linear-gradient(180deg, color-mix(in oklab, var(--panel), transparent 25%), transparent); border-bottom:1px solid var(--border); }
    .container { max-width: 1200px; margin:0 auto; padding: 16px; }
    .row { display:flex; gap:16px; }
    .col { flex:1; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: 0 6px 24px rgba(0,0,0,.2); }
    .title { font-weight:700; font-size:20px; margin:0 0 8px; }
    .subtitle { color: var(--muted); font-size: 13px; }
    textarea { width:100%; min-height: 140px; padding:12px; border-radius:12px; border:1px solid var(--border); background: var(--panel); color:var(--text); font: inherit; resize: vertical; }
    input[type="text"] { width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background: var(--panel); color:var(--text); font: inherit; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background: var(--chip); color:var(--text); cursor:pointer; font-weight:600; }
    .btn.primary { background: linear-gradient(135deg, var(--accent), var(--primary)); color:#081017; border: none; }
    .btn.ghost { background: transparent; }
    .btn.danger { background: var(--danger); color: white; border: none; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; font-size:12px; border-radius:999px; background: var(--chip); border:1px solid var(--border); color:var(--muted); }
    .label { font-size:12px; color:var(--muted); }
    .pred-badge { font-weight:700; padding:6px 10px; border-radius:999px; }
    .pred-FAKE { background: color-mix(in oklab, var(--danger), transparent 80%); color: var(--danger); }
    .pred-REAL { background: color-mix(in oklab, var(--ok), transparent 80%); color: var(--ok); }
    .grid { display:grid; gap:16px; grid-template-columns: 1.1fr .9fr; }
    .split { display:grid; gap:16px; grid-template-columns: 1fr; }
    .history { max-height: 520px; overflow:auto; display:flex; flex-direction:column; gap:8px; }
    .history-item { border:1px solid var(--border); padding:12px; border-radius:12px; background: var(--panel); cursor:pointer; }
    .history-item:hover { border-color: var(--accent); }
    .muted { color: var(--muted); }
    .chat { display:flex; flex-direction:column; gap:12px; max-height: 420px; overflow:auto; padding: 8px 0; }
    .bubble { padding:12px; border-radius:14px; max-width: 85%; word-wrap: break-word; }
    .bubble.user { background: var(--accent); color: white; align-self:flex-end; }
    .bubble.assistant { background: var(--panel); border:1px solid var(--border); align-self:flex-start; }
    .typing { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: var(--muted); margin: 0 2px; animation: typing 1.4s infinite ease-in-out; }
    .typing:nth-child(1) { animation-delay: 0s; }
    .typing:nth-child(2) { animation-delay: 0.2s; }
    .typing:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: scale(1); opacity: 0.5; }
      30% { transform: scale(1.2); opacity: 1; }
    }
    .footer { padding:12px; border-top:1px solid var(--border); display:flex; gap:8px; }
    .chip-row { display:flex; flex-wrap: wrap; gap:8px; }
    .switch { position: relative; display:inline-block; width: 46px; height: 26px; }
    .switch input { opacity:0; width:0; height:0; }
    .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#334155; transition:.2s; border-radius:999px; }
    .slider:before { position:absolute; content:""; height: 20px; width:20px; left:3px; top:3px; background:white; transition:.2s; border-radius:50%; }
    input:checked + .slider { background: #fbbf24; }
    input:checked + .slider:before { transform: translateX(20px); }
    .table { width:100%; border-collapse: collapse; font-size: 14px; }
    .table th, .table td { border-bottom:1px solid var(--border); padding:8px; text-align:left; }
    .empty { border:1px dashed var(--border); padding:12px; border-radius:12px; color:var(--muted); text-align: center; }
    @media (max-width: 1024px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="container row" style="align-items:center; justify-content:space-between;">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--primary));"></div>
        <div>
          <div style="font-weight:800; letter-spacing:.2px;">Fake News Detector</div>
          <div class="subtitle">DistilBERT prediction Â· Gemini reasoning Â· Supabase history</div>
        </div>
      </div>
      <div class="toolbar">
        <span class="label">Theme</span>
        <label class="switch" title="Toggle light/dark">
          <input id="themeToggle" type="checkbox" />
          <span class="slider"></span>
        </label>
        <button id="clearAll" class="btn danger" title="Delete all local history & Supabase session">
          Delete Session
        </button>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:20px; padding-bottom:32px;">
    <div class="grid">
      <!-- Left: Input + Results -->
      <section class="col split">
        <div class="card">
          <h2 class="title">Masukkan teks berita</h2>
          <p class="subtitle">Paste berita atau tulis ringkasan. Klik <b>Prediksi</b> â†’ kita jalankan DistilBERT â†’ lalu <b>Analisis</b> dengan Gemini. Kamu bisa lanjut <b>tanya</b> ke LLM.</p>
          <textarea id="newsInput" placeholder="Tulis teks berita di sini..."></textarea>
          <div class="toolbar" style="margin-top:12px;">
            <button id="btnPredict" class="btn primary">âš¡ Prediksi (DistilBERT)</button>
            <button id="btnAnalyze" class="btn" disabled>ðŸ§  Analisis Lanjutan (Gemini)</button>
            <span id="status" class="pill">Idle</span>
          </div>
        </div>

        <div class="row">
          <div class="col card">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
              <h3 class="title" style="font-size:18px;">Hasil Prediksi</h3>
              <div id="predBadge" class="pred-badge">â€”</div>
            </div>
            <div class="chip-row" style="margin:8px 0 12px;">
              <span class="pill">Model: <span id="modelVersion" class="muted" style="margin-left:6px;">â€”</span></span>
              <span class="pill">Confidence: <span id="confidence" style="margin-left:6px;">â€”</span></span>
              <span class="pill">Waktu: <span id="predTime" style="margin-left:6px;">â€”</span></span>
            </div>
            <div id="predText" class="muted">Belum ada prediksi.</div>
          </div>

          <div class="col card">
            <h3 class="title" style="font-size:18px;">Analisis LLM</h3>
            <div id="analysisSummary" class="muted">Belum dianalisis.</div>
            <div style="margin-top:12px;">
              <canvas id="factorsChart" height="160"></canvas>
            </div>
            <div id="factorsList" style="margin-top:8px;"></div>
          </div>
        </div>

        <div class="card">
          <h3 class="title" style="font-size:18px;">Tanya LLM</h3>
          <div class="chat" id="chatBox"></div>
          <div class="footer">
            <input id="chatInput" type="text" placeholder="Tanyakan apa pun tentang hasil di atas..." />
            <button id="btnSend" class="btn primary">Kirim</button>
          </div>
        </div>
      </section>

      <!-- Right: History -->
      <aside class="col card">
        <h3 class="title" style="font-size:18px;">Riwayat</h3>
        <div class="toolbar" style="margin-bottom:12px;">
          <button id="refreshHistory" class="btn ghost">â†» Refresh</button>
          <button id="purgeHistory" class="btn danger">Hapus dari Supabase</button>
        </div>
        <div id="historyList" class="history"></div>
      </aside>
    </div>

    <section class="container" style="margin-top:24px;">
      <div class="card">
        <h3 class="title" style="font-size:18px;">Alasan Klasifikasi (LLM Factors)</h3>
        <table class="table">
          <thead>
            <tr><th>Faktor</th><th>Bobot</th><th>Penjelasan</th></tr>
          </thead>
          <tbody id="factorsTableBody">
            <tr><td colspan="3" class="empty">Belum ada data.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

<script type="module">
  // ========================
  // ðŸ”§ CONFIG
  // ========================
  const BACKEND_BASE_URL = localStorage.getItem('BACKEND_BASE_URL') || 'http://82.197.71.171:4000';
  const SUPABASE_URL = 'https://blnehwafvmysyyudcglg.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsbmVod2Fmdm15c3l5dWRjZ2xnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5NzgwNDEsImV4cCI6MjA3NDU1NDA0MX0.MJPfcA0iBSw5iHNrCmpdjjVGIUv5O4a4R9L9nCyw4Sw';

  // ========================
  // ðŸ“¦ Supabase Client
  // ========================
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ========================
  // ðŸŽ¨ Theme Persistence
  // ========================
  const themeToggle = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('theme') || 'dark';
  if (savedTheme === 'light') {
    document.documentElement.classList.add('light');
    themeToggle.checked = true;
  }
  themeToggle.addEventListener('change', () => {
    const light = themeToggle.checked;
    document.documentElement.classList.toggle('light', light);
    localStorage.setItem('theme', light ? 'light' : 'dark');
    redrawChart();
  });

  // ========================
  // ðŸ§  UI Elements
  // ========================
  const newsInput = document.getElementById('newsInput');
  const btnPredict = document.getElementById('btnPredict');
  const btnAnalyze = document.getElementById('btnAnalyze');
  const statusPill = document.getElementById('status');
  const predBadge = document.getElementById('predBadge');
  const modelVersion = document.getElementById('modelVersion');
  const confidenceEl = document.getElementById('confidence');
  const predTime = document.getElementById('predTime');
  const predText = document.getElementById('predText');
  const analysisSummary = document.getElementById('analysisSummary');
  const factorsList = document.getElementById('factorsList');
  const factorsTableBody = document.getElementById('factorsTableBody');
  const historyList = document.getElementById('historyList');
  const btnSend = document.getElementById('btnSend');
  const chatInput = document.getElementById('chatInput');
  const chatBox = document.getElementById('chatBox');
  const clearAll = document.getElementById('clearAll');
  const purgeHistory = document.getElementById('purgeHistory');
  const refreshHistory = document.getElementById('refreshHistory');

  let currentSessionId = localStorage.getItem('session_id');
  let chartInstance = null;
  let isStreaming = false;

  function setStatus(text){ statusPill.textContent = text; }
  
  function addChatBubble(role, text, isStreaming = false){
    const div = document.createElement("div");
    div.className = `bubble ${role}`;
    
    if (isStreaming && role === 'assistant') {
      div.id = 'streaming-bubble';
    }
    
    if (isStreaming && role === 'assistant' && !text) {
      // Show typing indicator
      div.innerHTML = '<span class="typing"></span><span class="typing"></span><span class="typing"></span>';
    } else {
      div.textContent = text;
    }
    
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    return div;
  }

  function updateStreamingBubble(text) {
    let bubble = document.getElementById('streaming-bubble');
    if (!bubble) {
      bubble = addChatBubble('assistant', text);
    } else {
      bubble.textContent = text;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function setPredictionUI(pred){
    if(!pred) return;
    predBadge.textContent = pred.label || 'â€”';
    predBadge.className = `pred-badge pred-${pred.label || ''}`;
    modelVersion.textContent = pred.model_version || 'distilbert-finetuned';
    confidenceEl.textContent = pred.score != null ? (Number(pred.score)*100).toFixed(1) + '%' : 'â€”';
    predTime.textContent = pred.timestamp ? new Date(pred.timestamp).toLocaleString() : new Date().toLocaleString();
    predText.textContent = newsInput.value.slice(0, 220) + (newsInput.value.length > 220 ? 'â€¦' : '');
  }

  function renderFactors(list = []){
    factorsList.innerHTML = '';
    factorsTableBody.innerHTML = '';
    if(!list.length){
      factorsTableBody.innerHTML = '<tr><td colspan="3" class="empty">Belum ada data.</td></tr>';
      return;
    }
    list.forEach(f => {
      const chip = document.createElement('span');
      chip.className = 'pill';
      chip.textContent = `${f.name} â€¢ ${(f.weight*100).toFixed(0)}%`;
      factorsList.appendChild(chip);
    });
    list.forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHTML(f.name)}</td><td>${(f.weight*100).toFixed(1)}%</td><td>${escapeHTML(f.explanation || '-')}`;
      factorsTableBody.appendChild(tr);
    });
  }

  function escapeHTML(s=''){ 
    if (!s) return '';
    return s.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m])); 
  }

  async function createSessionIfNeeded(){
    if(currentSessionId) return currentSessionId;
    const text = newsInput.value.trim();
    const title = (text.split('.').shift() || 'Untitled').slice(0, 60);
    const { data, error } = await supabase.from('sessions').insert({ title, source_text: text }).select('id').single();
    if(error) throw error;
    currentSessionId = data.id;
    localStorage.setItem('session_id', currentSessionId);
    return currentSessionId;
  }

  async function savePrediction(pred){
    if(!currentSessionId) await createSessionIfNeeded();
    const payload = {
      session_id: currentSessionId,
      text: newsInput.value.trim(),
      label: pred.label,
      score: pred.score,
      model_version: pred.model_version || 'distilbert-finetuned'
    };
    await supabase.from('predictions').insert(payload);
  }

  async function saveAnalysis(analysis){
    if(!currentSessionId) await createSessionIfNeeded();
    const payload = { 
      session_id: currentSessionId, 
      summary: analysis.summary, 
      factors: analysis.factors || [], 
      chart: analysis.chart || {}, 
      tips: analysis.tips || [] 
    };
    await supabase.from('analyses').insert(payload);
  }

  async function saveChat(role, message){
    if(!currentSessionId) await createSessionIfNeeded();
    await supabase.from('chats').insert({ session_id: currentSessionId, role, message });
  }

  // ========================
  // ðŸ“Š Chart.js
  // ========================
  const ctx = document.getElementById('factorsChart');
  function redrawChart(){ 
    if(chartInstance){ 
      chartInstance.update('none'); 
    } 
  }
  
  function renderChart(labels=[], weights=[]){
    const border = getComputedStyle(document.documentElement).getPropertyValue('--border');
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text');
    const mutedColor = getComputedStyle(document.documentElement).getPropertyValue('--muted');
    
    if(chartInstance){ 
      chartInstance.destroy(); 
    }
    
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: { 
        labels, 
        datasets: [{ 
          label: 'Faktor Bobot', 
          data: weights,
          backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary'),
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
          borderWidth: 1
        }] 
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { 
            display: false 
          } 
        },
        scales: {
          x: { 
            grid: { 
              color: border 
            },
            ticks: {
              color: textColor
            }
          },
          y: { 
            beginAtZero: true,
            max: 1,
            grid: { 
              color: border 
            },
            ticks: {
              color: textColor,
              callback: function(value) {
                return (value * 100).toFixed(0) + '%';
              }
            }
          }
        }
      }
    });
  }

  // ========================
  // ðŸš€ Actions
  // ========================
  btnPredict.addEventListener('click', async () => {
    const text = newsInput.value.trim();
    if(!text){ alert('Isi dulu teks beritanya.'); return; }
    try {
      setStatus('Predictingâ€¦');
      btnPredict.disabled = true;
      await createSessionIfNeeded();
      const res = await fetch(`${BACKEND_BASE_URL}/api/predict`, { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ text }) 
      });
      if(!res.ok) throw new Error('Predict API error');
      const pred = await res.json();
      setPredictionUI(pred);
      await savePrediction(pred);
      setStatus('Prediction complete');
      btnAnalyze.disabled = false;
      await loadHistory();
    } catch (e){
      console.error(e);
      setStatus('Prediction failed');
      alert('Gagal prediksi. Cek backend /api/predict & CORS.');
    } finally { 
      btnPredict.disabled = false; 
    }
  });

  btnAnalyze.addEventListener('click', async () => {
    const text = newsInput.value.trim();
    if(!text){ alert('Isi dulu teks beritanya.'); return; }
    const label = predBadge.textContent;
    if(label === 'â€”'){ alert('Jalankan Prediksi dulu.'); return; }
    try {
      setStatus('Analyzingâ€¦');
      btnAnalyze.disabled = true;
      const res = await fetch(`${BACKEND_BASE_URL}/api/analyze`, { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ 
          text, 
          prediction: { 
            label, 
            score: parseFloat(confidenceEl.textContent) / 100 || 0.5 
          } 
        }) 
      });
      if(!res.ok) throw new Error('Analyze API error');
      const analysis = await res.json();
      analysisSummary.textContent = analysis.summary || 'â€”';
      const factors = analysis.factors || [];
      renderFactors(factors);
      const labels = analysis.chart?.labels || factors.map(f=>f.name);
      const weights = analysis.chart?.weights || factors.map(f=>f.weight);
      renderChart(labels, weights);
      await saveAnalysis(analysis);
      await loadHistory();
      setStatus('Analysis complete');
    } catch (e){
      console.error(e);
      setStatus('Analysis failed');
      alert('Gagal analisis. Cek backend /api/analyze & CORS.');
    } finally { 
      btnAnalyze.disabled = false; 
    }
  });

  btnSend.addEventListener('click', sendChat);
  chatInput.addEventListener('keydown', (e)=>{ 
    if(e.key==='Enter'){ 
      e.preventDefault(); 
      sendChat(); 
    } 
  });

  async function sendChat(){
    if (isStreaming) return;
    
    const message = chatInput.value.trim();
    if(!message) return;

    addChatBubble("user", message);
    chatInput.value = "";
    btnSend.disabled = true;

    // Add typing indicator
    const typingBubble = addChatBubble('assistant', '', true);
    
    const context = {
      prediction: { 
        label: predBadge.textContent, 
        score: parseFloat(confidenceEl.textContent) / 100 || 0 
      },
      analysis: { 
        summary: analysisSummary.textContent 
      },
      text: newsInput.value.trim()
    };

    await saveChat('user', message);

    try {
      setStatus('Chattingâ€¦');
      isStreaming = true;

      const res = await fetch(`${BACKEND_BASE_URL}/api/chat`, { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ 
          message: message, 
          context,
          session_id: currentSessionId 
        }) 
      });

      if(!res.ok) throw new Error('Chat API error');
      
      const data = await res.json();
      const reply = data.reply || "â€”";
      
      // Remove typing indicator and add actual response
      typingBubble.remove();
      addChatBubble('assistant', reply);
      
      await saveChat('assistant', reply);
      await loadHistory();
      setStatus('Idle');
    } catch (e){
      console.error(e);
      setStatus('Chat failed');
      typingBubble.remove();
      addChatBubble('assistant', 'Gagal mengirim pesan. Cek koneksi atau backend.');
    } finally { 
      btnSend.disabled = false; 
      isStreaming = false;
    }
  }

  clearAll.addEventListener('click', async ()=>{
    if(!currentSessionId){ 
      localStorage.removeItem('session_id'); 
      location.reload(); 
      return; 
    }
    if(!confirm('Hapus session lokal saja? (Supabase tetap)')) return;
    localStorage.removeItem('session_id');
    location.reload();
  });

  purgeHistory.addEventListener('click', async ()=>{
    if(!currentSessionId) { 
      alert('Tidak ada session untuk dihapus.'); 
      return; 
    }
    const ok = confirm('Hapus session ini dari Supabase juga? (semua prediksi, analisis, chat)');
    if(!ok) return;
    try{
      await supabase.from('sessions').delete().eq('id', currentSessionId);
      localStorage.removeItem('session_id');
      location.reload();
    }catch(e){ 
      alert('Gagal hapus di Supabase: '+e.message); 
    }
  });

  refreshHistory.addEventListener('click', loadHistory);

  async function loadHistory(){
    historyList.innerHTML = '<div class="muted">Loadingâ€¦</div>';
    let { data: sessions, error } = await supabase
      .from('sessions')
      .select('id, created_at, title')
      .order('created_at', { ascending: false })
      .limit(50);
      
    if(error){ 
      historyList.innerHTML = '<div class="muted">Gagal load history.</div>'; 
      return; 
    }
    
    if(!sessions?.length){ 
      historyList.innerHTML = '<div class="empty">Belum ada sesi tersimpan.</div>'; 
      return; 
    }
    
    historyList.innerHTML = '';
    sessions.forEach(s => {
      const d = new Date(s.created_at).toLocaleString();
      const div = document.createElement('div');
      div.className = 'history-item';
      div.innerHTML = `<div style="font-weight:600;">${escapeHTML(s.title || 'Untitled')}</div><div class="muted" style="font-size:12px;">${d} Â· ${s.id.slice(0,8)}</div>`;
      div.onclick = async ()=>{
        currentSessionId = s.id; 
        localStorage.setItem('session_id', currentSessionId);
        await hydrateFromSession(s.id);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      historyList.appendChild(div);
    });
  }

  async function hydrateFromSession(id){
    // Load last prediction
    const { data: preds } = await supabase
      .from('predictions')
      .select('*')
      .eq('session_id', id)
      .order('created_at', { ascending:false })
      .limit(1);
      
    if(preds && preds.length){
      const p = preds[0];
      setPredictionUI({ 
        label: p.label, 
        score: p.score, 
        model_version: p.model_version, 
        timestamp: p.created_at 
      });
      newsInput.value = p.text || '';
      btnAnalyze.disabled = false;
    }
    
    // Load last analysis
    const { data: analyses } = await supabase
      .from('analyses')
      .select('*')
      .eq('session_id', id)
      .order('created_at', { ascending:false })
      .limit(1);
      
    if(analyses && analyses.length){
      const a = analyses[0];
      analysisSummary.textContent = (a.summary || 'â€”').replace(/```[^`]*```/g,'').trim();
      const factors = Array.isArray(a.factors) ? a.factors : [];
      renderFactors(factors);
      const labels = a.chart?.labels || factors.map(f=>f.name);
      const weights = a.chart?.weights || factors.map(f=>f.weight);
      renderChart(labels, weights);
    }
    
    // Load chat
    chatBox.innerHTML = '';
    const { data: chats } = await supabase
      .from('chats')
      .select('*')
      .eq('session_id', id)
      .order('created_at', { ascending:true })
      .limit(200);
      
    if(chats){ 
      chats.forEach(c => addChatBubble(c.role, c.message)); 
    }
  }

  // Initialize
  (async function init(){
    await loadHistory();
    if(currentSessionId){ 
      await hydrateFromSession(currentSessionId); 
    }
  })();
</script>
</body>
</html>
